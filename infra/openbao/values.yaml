server:
  ha:
    enabled: true
    replicas: 3
    
    # Init container to get transit token via Kubernetes auth
    extraInitContainers:
      - name: transit-auth
        image: openbao/openbao:2.0.0
        command:
          - /bin/sh
          - -c
          - |
            # Wait for transit to be ready
            until wget -q -O- http://openbao-transit:8200/v1/sys/health > /dev/null 2>&1; do
              echo "Waiting for transit OpenBao..."
              sleep 2
            done
            
            # Get Kubernetes service account token
            KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
            
            # Authenticate to transit OpenBao using Kubernetes auth
            TOKEN=$(bao write -address=http://openbao-transit:8200 \
              -field=token \
              auth/kubernetes/login \
              role=autounseal \
              jwt=${KUBE_TOKEN})
            
            # Create a wrapper script that sets the token
            cat > /vault/scripts/entrypoint.sh <<'SCRIPT'
            #!/bin/sh
            export TRANSIT_TOKEN="REPLACE_TOKEN"
            exec /usr/local/bin/docker-entrypoint.sh server
            SCRIPT
            
            # Replace the token in the script
            sed -i "s|REPLACE_TOKEN|${TOKEN}|g" /vault/scripts/entrypoint.sh
            chmod +x /vault/scripts/entrypoint.sh
        volumeMounts:
          - name: scripts
            mountPath: /vault/scripts
    
    # Add volumes
    extraVolumes:
      - name: scripts
        emptyDir: {}
    
    # Mount scripts volume
    volumeMounts:
      - name: scripts
        mountPath: /vault/scripts
    
    # Override command to use our wrapper script
    command:
      - /vault/scripts/entrypoint.sh
    
    config: |
      storage "postgresql" {
        connection_url = "postgresql://admin:admin@postgres-cluster-rw.postgres.svc.cluster.local:5432/openbao_db?sslmode=disable"
        ha_enabled = "true"
      }

      listener "tcp" {
        address     = "0.0.0.0:8200"
        tls_disable = 1
      }

      seal "transit" {
        address = "http://openbao-transit:8200"
        token = "${TRANSIT_TOKEN}"
        disable_renewal = "false"
        key_name = "autounseal"
        mount_path = "transit/"
      }

      api_addr = "http://$(POD_IP):8200"
      cluster_addr = "https://$(POD_IP):8201"

      ui = true

      service_registration "kubernetes" {}

  dataStorage:
    enabled: false

  standalone:
    enabled: false

  auditStorage:
    enabled: true
    size: 1Gi

  ui:
    enabled: true

  resources:
    requests:
      memory: 256Mi
      cpu: 250m
    limits:
      memory: 512Mi
      cpu: 500m

  extraSecretEnvironmentVars:
    - envName: PGHOST
      secretName: openbao-postgres-secret
      secretKey: PGHOST
    - envName: PGPORT
      secretName: openbao-postgres-secret
      secretKey: PGPORT
    - envName: PGUSER
      secretName: openbao-postgres-secret
      secretKey: PGUSER
    - envName: PGPASSWORD
      secretName: openbao-postgres-secret
      secretKey: PGPASSWORD
    - envName: OPENBAO_DB
      secretName: openbao-postgres-secret
      secretKey: OPENBAO_DB

injector:
  enabled: true
  replicas: 2
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m

global:
  enabled: true
  tlsDisable: true

podDisruptionBudget:
  enabled: true
  maxUnavailable: 1